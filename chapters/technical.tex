\chapter{Technisch Ontwerp}
\label{ch:technical}

\section{Hierarchie}

Zoals beschreven kan de architectuur van het systeem (sectie \ref{sec:func:arch})
opgedeeld worden in zes logische blokken:

\begin{enumerate}
    \item De \emph{reader}
    \item De \emph{detector}
    \item De \emph{recognizer}
    \item De \emph{localizer}
    \item De \emph{controller}
\end{enumerate}

Deze logische blokken kunnen worden opgedeeld in een aantal sub-blokken. De
hierarchie van deze sub-blokken is te zien in figuur \ref{fig:hierarchy}.

\begin{figure}[H]
    % \begin{center}
        \input{figures/ipo/hierarchy.tex}
    % \end{center}
    \caption{De hierarchie van het Autonerf systeem}
    \label{fig:hierarchy}
\end{figure}

\section{Architectuur}

De data-flow van het systeem begint bij het \emph{reader} subsysteem. Dit subsysteem
is verantwoordelijk voor het uitlezen van de camera en het verkrijgen van individuele
frames vanuit de camera. Dit systeem stuurt de uitgelezen frames door naar het
\emph{detector} subsysteem die probeert gezichten te detecteren in het systeem.
Als dit gelukt is en een gezicht gedetecteerd is word de data doorgestuurd naar
de \emph{recognizer} en \emph{localizer} subsystemen. Het \emph{recognizer}
subsysteem probeert het gedetecteerde gezicht te herkennen. Als een gezicht
herkend wordt, wordt dit doorgegeven aan het \emph{controller} subsysteem.
Het \emph{localizer} subsysteem berekend de locatie van het gezicht en de afwijking
ervan tot het centrum van het frame (met eventueel een bepaalde toegestane
\emph{offset}). Het \emph{controller} subsysteem is uiteindelijk verantwoordelijk
voor de aansturing van de Nerfgun.

\subsection{De \emph{reader}}

Zoals getoont in figuur \ref{fig:ipo-reader} heeft het \emph{reader} subsysteem
maar één input en output: de frames van de camera. Dit gebeurd door middel van
een USB-verbinding met de camera. Het \emph{reader} subsysteem vervult de rol
van de \emph{Acquisition} stap binnen het vision-model.

De output van het systeem is een RGB frame van 640 $\times$ 480 pixels wat wordt
opgeslagen in een matrix. Deze matrix is de output van het systeem.

\begin{figure}[H]
    \begin{center}
        \input{figures/ipo/reader.tex}
    \end{center}
    \caption{Het IPO-schema van het \emph{reader} subsysteem}
    \label{fig:ipo-reader}
\end{figure}

\subsection{De \emph{detector}}

Het IPO-schema van het \emph{detector} subsysteem (figuur \ref{fig:ipo-detector})
heeft één input en output. De input van het systeem is het uitgelezen frame van
de camera (de eerder genoemde frame). De outputs zijn eventueel gedetecteerde gezichten en het originele
frame dat ontvangen is. Als er geen gezicht gedetecteerd wordt stopt de data-stroom
in dit systeem. Binnen het vision-model vervult de \emph{detection} de
stappen \emph{enhancement}, \emph{segmentation}, \emph{feature extraction} en
\emph{classification}.

\begin{figure}[H]
    \begin{center}
        \input{figures/ipo/detector.tex}
    \end{center}
    \caption{Het IPO-schema van het \emph{detector} subsysteem}
    \label{fig:ipo-detector}
\end{figure}

De subsystemen van het \emph{detector} subsysteem zijn de \emph{enhancer},
\emph{segmentator}, \emph{feature extractor} en \emph{classifier} systemen.

\subsubsection{Enhancer}

Het enhancer subsubsysteem krijgt als input het frame wat is uitgelezen door
het \emph{reader} systeem. Allereerst wordt dit frame geconverteerd naar een
grayscale beeld. Daarna wordt er \emph{histogram equalization} uitgevoerd
waardoor de gezichtdetectie accurater wordt.

\subsubsection{Segmentator}

Het \emph{segmentator} subsysteem heeft als input
het verbeterde frame van het \emph{enhancer} subsubsysteem. De pixels in dit
frame worden vergeleken door middel van integratie. De uitkomst van deze
vergelijking wordt opgeslagen in een matrix die de output van het systeem is.

\subsubsection{Feature extractor}

Als input verwacht het \emph{feature extractor} subsysteem het gesegmenteerde
frame van het \emph{segmentator} subsysteem. Deze matrix wordt gecontroleerd
op bepaalde \emph{Haar-features}. De output van het systeem is een overzicht
van welke features waar in het frame aanwezig zijn.

\subsubsection{Classifier}

Als input verwacht het \emph{classifier} subsysteem de output van het \emph{feature
extractor} subsysteem. De \emph{Haar Classifier} beslist op basis van het aantal
en de verdeling van de Haar features of er sprake is van een gezicht of niet.
De output zijn de coordinaten van de gedetecteerde gezichten.

\subsection{De \emph{recognizer}}

Het \emph{recognizer} subsysteem (figuur \ref{fig:ipo-recognizer}) heeft als
inputs:

\begin{enumerate}
    \item De coordinaten van gedetecteerde gezichten;
    \item en het frame ontvangen door het \emph{detector} subsysteem.
\end{enumerate}

Als output heeft het subsysteem een persoon wat eventueel herkend is. Als er
geen persoon herkend is in het frame heeft het systeem geen verdere outputs.
Het systeem vervult, net als het \emph{detector} subsysteem de stappen \emph{segmentation},
\emph{feature extraction} en \emph{classification} binnen het vision-model. Er
zijn dan ook dezelfde subsystem aanwezig als binnen het \emph{detector} subsysteem.

\begin{figure}[H]
    \begin{center}
        \input{figures/ipo/recognizer.tex}
    \end{center}
    \caption{Het IPO-schema van het \emph{recognizer} subsysteem}
    \label{fig:ipo-recognizer}
\end{figure}

\subsubsection{Segmentator}

De input van het \emph{segmentator} sub-subsysteem is het frame wat verkregen is
door het \emph{reader} subsysteem. Dit systeem maakt gebruik van \emph{Local
Binary Patterns} (LBP) om gezichten te herkennen. Het LBP algoritme vergelijkt
door middel van thresholds elke pixel met zijn \emph{neighbours}. De output
van het \emph{segmentator} systeem is een LBP-matrix waarin elke pixel een
waarde heeft die de lokale structuur van zijn neighbours aangeeft.

\subsubsection{Feature extractor}

De input van het \emph{feature extractor} subsubsysteem is de LBP-matrix die door
het \emph{segmentator} subsysteem berekend wordt. Deze matrix wordt opgedeeld
in lokale regio's. Van deze regio's wordt een histogram gemaakt die vervolgens
gelinkt in een matrix worden geplaatst waardoor de features in alle regio's
zichtbaar zijn. Deze histogram-matrix is de output van het \emph{feature
extractor} subsubsysteem.

\subsubsection{Classifier}

De input van het \emph{classifier} sub-subsysteem is de histogram-matrix output
van het \emph{segmentator} sub-subsysteem. Deze matrix wordt vergeleken met matrixes
van foto's uit de gezichten database. Op basis van overeenkomsten wordt bepaald
of de gezichten van dezelfde persoon zijn. De output van het systeem is een
voorspeld label (elk persoon heeft in de database zijn eigen label).

\subsection{De \emph{localizer}}

Zoals te zien in figuur \ref{fig:ipo-localizer} heeft het \emph{localizer}
subsysteem twee inputs: de coordinaten van eventueel herkende gezichten en
het frame dat ontvangen is door het \emph{detector} subsysteem. De output
van het systeem zijn de ruimtelijke coordinaten van de gedetecteerde gezichten
ten opzichte van het centrum van het frame (de origin).

\begin{figure}[H]
    \begin{center}
        \input{figures/ipo/localizer.tex}
    \end{center}
    \caption{Het IPO-schema van het \emph{localizer} subsysteem}
    \label{fig:ipo-localizer}
\end{figure}

\subsection{De \emph{controller}}

Het \emph{controller} subsysteem (figuur \ref{fig:ipo-controller}) heeft als inputs:

\begin{enumerate}
    \item Het frame ontvangen door het \emph{detector} subsysteem;
    \item De radiale afwijking van eventueel gedetecteerde gezichten;
    \item en eventueel herkende personen binnen het frame.
\end{enumerate}

Als output heeft het systeem de commando's die naar de Nerfgun gestuurd moeten
worden.

\begin{figure}[H]
    \begin{center}
        \input{figures/ipo/controller.tex}
    \end{center}
    \caption{Het IPO-schema van het \emph{controller} subsysteem}
    \label{fig:ipo-controller}
\end{figure}
